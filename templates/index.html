<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wikidata AI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —è–∑—ã–∫–æ–≤ -->
    <div style="position:fixed;top:10px;right:10px;">
        <select id="langSel">
            {% for code, name in languages.items() %}
              <option value="{{ code }}" {% if code==lang %}selected{% endif %}>{{ name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="container">
        <header>
            <h1>üß† Wikidata AI</h1>
            <p class="subtitle">–°–ø—Ä–æ—Å–∏ –æ–±–æ –≤—Å—ë–º ‚Äî –æ—Ç –ú–∏–∫–µ–ª–∞–Ω–¥–∂–µ–ª–æ –¥–æ VK. –û—Ç–≤–µ—Ç—ã –∏–∑ –æ—Ç–∫—Ä—ã—Ç–æ–π –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π.</p>
        </header>

        <div class="chat-container">
            <div class="messages-area" id="messagesArea">
                <div class="message bot-message">
                    –ü—Ä–∏–≤–µ—Ç! –Ø ‚Äî –≤–∞—à —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –Ω–∞ –±–∞–∑–µ Wikidata.<br>
                    –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å: <em>¬´–ö—Ç–æ —Ç–∞–∫–æ–π –ú–∏–∫–µ–ª–∞–Ω–¥–∂–µ–ª–æ?¬ª</em> –∏–ª–∏ <em>¬´–ß—Ç–æ —Ç–∞–∫–æ–µ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ?¬ª</em>
                </div>
            </div>
            <div class="input-area">
                <input type="text" class="message-input" id="messageInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–∞—Ä–∞–≤–∞–¥–∂–æ, Microsoft, –≠–π—Ñ–µ–ª–µ–≤–∞ –±–∞—à–Ω—è...">
                <button class="send-button" id="sendButton">‚û§</button>
            </div>
        </div>

        <div class="examples">
            <div class="example-item" onclick="useExample('–ö—Ç–æ —Ç–∞–∫–æ–π –ú–∏–∫–µ–ª–∞–Ω–¥–∂–µ–ª–æ?')">–ö—Ç–æ —Ç–∞–∫–æ–π –ú–∏–∫–µ–ª–∞–Ω–¥–∂–µ–ª–æ?</div>
            <div class="example-item" onclick="useExample('–ß—Ç–æ —Ç–∞–∫–æ–µ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ?')">–ß—Ç–æ —Ç–∞–∫–æ–µ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ?</div>
            <div class="example-item" onclick="useExample('–ö—Ç–æ —Ç–∞–∫–∞—è –ú–∞—Ä–∏—è –ö—é—Ä–∏?')">–ö—Ç–æ —Ç–∞–∫–∞—è –ú–∞—Ä–∏—è –ö—é—Ä–∏?</div>
            <div class="example-item" onclick="useExample('Microsoft')">Microsoft</div>
        </div>
    </div>

    <script>
        const langSel      = document.getElementById("langSel");
        const messagesArea = document.getElementById("messagesArea");
        const messageInput = document.getElementById("messageInput");
        const sendButton   = document.getElementById("sendButton");

        langSel.onchange = () => fetch(`/set_lang/${langSel.value}`).then(() => location.reload());

        let lastQuestion = "";

        function addMessage(text, isUser=false, showMore=false){
            const div = document.createElement("div");
            div.className = `message ${isUser?'user-message':'bot-message'}`;
            const time = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
            // –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º Markdown-—Å—Å—ã–ª–∫–∏ –≤ HTML <a target="_blank">
            const html = text
                .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
                .replace(/\[üîó –ò—Å—Ç–æ—á–Ω–∏–∫\]\((https?:\/\/[^)]+)\)/g,
                         '<a href="$1" target="_blank" rel="noopener">üîó –ò—Å—Ç–æ—á–Ω–∏–∫</a>');
            div.innerHTML = `${html}<div class="message-time">${time}</div>`;
            messagesArea.appendChild(div);
            if(showMore){
                const moreBtn = document.createElement("button");
                moreBtn.textContent = "–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë";
                moreBtn.onclick = () => loadMore();
                messagesArea.appendChild(moreBtn);
            }
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        function useExample(text){
            messageInput.value = text;
            messageInput.focus();
        }

        async function sendMessage(){
            const msg = messageInput.value.trim();
            if(!msg) return;
            addMessage(msg, true);
            messageInput.value = '';
            sendButton.disabled = true;
            lastQuestion = msg;
            addMessage("<div class=thinking>–î—É–º–∞—é‚Ä¶</div>");
            try{
                const r = await fetch("/ask",{method:"POST",
                                              headers:{"Content-Type":"application/json"},
                                              body:JSON.stringify({question:msg})});
                const j = await r.json();
                messagesArea.removeChild(messagesArea.lastChild);
                addMessage(j.answer, false, j.more);
            }catch(e){
                messagesArea.removeChild(messagesArea.lastChild);
                addMessage("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º.");
            }
            sendButton.disabled = false;
        }

        async function loadMore(){
            const btn = document.querySelector("button");   // –∫–Ω–æ–ø–∫–∞ ¬´–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë¬ª
            if(btn) btn.disabled = true;
            addMessage("<div class=thinking>–î—É–º–∞—é‚Ä¶</div>");
            try{
                const r = await fetch("/more",{method:"POST",
                                               headers:{"Content-Type":"application/json"},
                                               body:JSON.stringify({question:lastQuestion})});
                const j = await r.json();
                messagesArea.removeChild(messagesArea.lastChild);
                addMessage(j.answer);
            }catch(e){
                messagesArea.removeChild(messagesArea.lastChild);
                addMessage("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º.");
            }
        }

        sendButton.onclick = sendMessage;
        messageInput.onkeypress = e => {if(e.key==="Enter") sendMessage();};
    </script>
</body>
</html>